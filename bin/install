#!/usr/bin/env bash

if [ "$1" = "-h" ]
then
  echo -e "usage: bin/install [source_path] [prefix_path]
\t source_path:
\t\t default: /opt/vim
\t prefix_path:
\t\t default: /usr/local"

  exit 0
fi

old_path=$PWD
current_user=$(whoami)
src_path=${1:-/opt/vim}
vim_prefix=${2:-/usr/local}

if [[ -d $src_path ]]
then
  cd $src_path
  hg pull
  hg update
else
  sudo mkdir -p  $src_path
  sudo chmod -R 755 $src_path
  sudo chown -R "$current_user:" $src_path
  cd $src_path
  hg clone https://vim.googlecode.com/hg/ .
fi

cd src

make clean
make distclean
./configure \
  --enable-gui=no \
  --without-x \
  --enable-multibyte \
  --with-tlib=ncurses \
  --enable-cscope \
  --with-features=huge \
  --enable-pythoninterp \
  --enable-rubyinterp \
  --prefix=$vim_prefix
make
sudo make install prefix=$vim_prefix

VIMRUNTIME=`vim -e -T dumb --cmd 'exe "set t_cm=\<C-M>"|echo $VIMRUNTIME|quit' | tr -d '\015' `

# Remove some useless
cd $VIMRUNTIME
sudo rm -rf $(find . \
  -iname "*vimball.vim" -o \
  -iname "*zip.vim" -o \
  -iname "*tex.vim" -o \
  -iname "*tar.vim" -o \
  -iname "*netrw*" -o \
  -iname "*getscript*" -o \
  -iname "*rrhelper*")

cd $old_path
vim --version
