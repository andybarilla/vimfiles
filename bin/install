#!/usr/bin/env bash

tty -s
if [[ -z "$DEBUG" ]] ; then
  exec 3>&1 &>/dev/null
else
  exec 3>&1
fi

if [ "$1" = "-h" ]
then
  echo -e "usage: bin/install [source_path] [prefix_path]
\t source_path:
\t\t default: /opt/vim
\t prefix_path:
\t\t default: /usr/local" >&3

  exit 0
fi

old_path=$PWD
current_user=$(whoami)
src_path=${1:-/opt/vim}
vim_prefix=${2:-/usr/local}
lua_path=$(which lua)
lua_prefix=${lua_path%/bin/lua}

echo "Downloading" >&3
if [[ -d $src_path ]]
then
  cd $src_path
  hg pull
  hg update
else
  sudo mkdir -p  $src_path
  sudo chmod -R 755 $src_path
  sudo chown -R "$current_user:" $src_path
  cd $src_path
  hg clone https://vim.googlecode.com/hg/ .
fi

cd src

echo "Compiling" >&3
make clean
make distclean
./configure \
  --with-features=huge \
  --with-tlib=ncurses \
  --disable-gui \
  --without-x \
  --disable-nls \
  --disable-gpm \
  --disable-netbeans \
  --disable-arabic \
  --disable-farsi \
  --disable-cscope \
  --disable-emacs_tags \
  --disable-keymap \
  --disable-langmap \
  --enable-feature=browse \
  --enable-multibyte \
  --enable-pythoninterp \
  --enable-rubyinterp \
  --enable-luainterp \
  --with-lua-prefix=$lua_prefix \
  --prefix=$vim_prefix
make
sudo make install prefix=$vim_prefix

VIMRUNTIME=`vim -e -T dumb --cmd 'exe "set t_cm=\<C-M>"|echo $VIMRUNTIME|quit' | tr -d '\015' `

echo "Remove unused default plugins" >&3
# Remove some useless
cd $VIMRUNTIME
sudo rm -rf $(find . \
  -iname "*vimball.vim" -o \
  -iname "*zip.vim" -o \
  -iname "*tex.vim" -o \
  -iname "*tar.vim" -o \
  -iname "*netrw*" -o \
  -iname "*getscript*" -o \
  -iname "*rrhelper*")

cd $old_path
vim --version >&3
